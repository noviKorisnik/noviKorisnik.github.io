import{G as c,Ib as k,J as a,M as b,N as g,h as f,i as s,m as p,n as m,p as v,ub as l,y as u}from"./chunk-HURRB3F2.js";var d=class e{canNavigateSubject=new s(!0);canNavigate$=this.canNavigateSubject.asObservable();sidebarOpenSubject=new s(!1);sidebarOpen$=this.sidebarOpenSubject.asObservable();bookPositionSubject=new s(null);bookPosition$=this.bookPositionSubject.asObservable();setNavigationState(t){this.canNavigateSubject.next(t)}openSidebar(){this.sidebarOpenSubject.next(!0)}closeSidebar(){this.sidebarOpenSubject.next(!1)}toggleSidebar(){this.sidebarOpenSubject.next(!this.sidebarOpenSubject.value)}isSidebarOpen(){return this.sidebarOpenSubject.value}setBookPosition(t){this.bookPositionSubject.next(t)}clearBookPosition(){this.bookPositionSubject.next(null)}static \u0275fac=function(o){return new(o||e)};static \u0275prov=a({token:e,factory:e.\u0275fac,providedIn:"root"})};var T=()=>g(d).canNavigate$;var B=class e{constructor(t){this.http=t;this.loadBooks()}apiUrl=k.apiUrl;booksSubject=new s([]);books$=this.booksSubject.asObservable();activeBookSubject=new f;activeBook$=this.activeBookSubject.asObservable();bookContentSubject=new s([]);bookContent$=this.bookContentSubject.asObservable();setActiveBook(t){this.activeBookSubject.next(t),this.loadBookContent(t)}loadBooks(){this.http.get(`${this.apiUrl}/books`).subscribe(t=>this.booksSubject.next(t))}getBooks(){return this.http.get(`${this.apiUrl}/books`)}createBook(t){return this.http.post(`${this.apiUrl}/books`,t).pipe(c({next:()=>{this.loadBooks()}}))}updateBook(t,o){return this.http.put(`${this.apiUrl}/books/${t}`,o).pipe(c({next:()=>{this.loadBooks()}}))}getBook(t){return this.http.get(`${this.apiUrl}/books/${t}`)}loadBookContent(t){this.getBookContent(t.id).subscribe(o=>this.buildBookContent(t,o))}buildBookContent(t,o){let r=o.filter(n=>!n.parentId).sort((n,$)=>n.order-$.order),i={id:"book",bookId:`${t.id}`,title:t.title,order:1,type:"book",expanded:!0,children:r};r.forEach(n=>this.setChildren(n,o)),this.bookContentSubject.next([i])}setChildren(t,o){let r=o.filter(i=>i.parentId==t.id).sort((i,n)=>i.order-n.order);(r.length||t.type=="chapter")&&(t.children=r,r.forEach(i=>this.setChildren(i,o)))}getBookContent(t){return this.http.get(`${this.apiUrl}/books/${t}/content`)}updateBookContent(t,o){let r=this.collectChanges(t);return r.removed=o.map(i=>i.id).filter(i=>!`${i}`.startsWith("fake-")),console.log(JSON.stringify(r,null,4)),this.http.put(`${this.apiUrl}/books/${t[0].bookId}/content`,r).pipe(c(()=>{this.loadBookContent({id:t[0].bookId,title:t[0].title})}))}collectChanges(t){let o={new:[],modified:[],removed:[]},r=i=>{i.forEach(n=>{n.isNew?o.new.push(this.prepareItemForUpdate(n)):n.isModified&&o.modified.push(this.prepareItemForUpdate(n)),n.children&&r(n.children)})};return r(t),o}prepareItemForUpdate(t){let o={id:t.id,bookId:t.bookId,type:t.type,title:t.title,order:t.order,sessionId:t.sessionId};return t.parentId!=="book"&&(o.parentId=t.parentId),o}static \u0275fac=function(o){return new(o||e)(b(l))};static \u0275prov=a({token:e,factory:e.\u0275fac,providedIn:"root"})};var j=class e{layoutModeSubject=new s("reader");layoutMode$=this.layoutModeSubject.asObservable();setLayoutMode(t){this.layoutModeSubject.next(t)}static \u0275fac=function(o){return new(o||e)};static \u0275prov=a({token:e,factory:e.\u0275fac,providedIn:"root"})};var y=class e{constructor(t){this.http=t;this.refreshBookCache()}apiUrl=k.apiUrl;booksCache=[];booksCacheTimestamp=0;CACHE_DURATION=60*60*1e3;booksSubject=new s([]);books$=this.booksSubject.asObservable();getBooks(){return this.isCacheValid()?p(this.booksCache):this.refreshBookCache()}refreshBookCache(){return this.http.get(`${this.apiUrl}/library/books`).pipe(c(t=>{this.booksCache=t,this.booksCacheTimestamp=Date.now(),this.booksSubject.next(t)}),u(t=>(console.error("Error fetching books:",t),p([]))))}isCacheValid(){return this.booksCache.length>0&&Date.now()-this.booksCacheTimestamp<this.CACHE_DURATION}getBookIdFromSlug(t){if(this.isCacheValid()){let o=this.booksCache.find(r=>r.urlSlug===t);return p(o?o.id:null)}return this.getBooks().pipe(v(o=>{let r=o.find(i=>i.urlSlug===t);return r?r.id:null}))}getBook(t){return this.http.get(`${this.apiUrl}/library/books/${t}`)}getBookContent(t){return this.http.get(`${this.apiUrl}/library/books/${t}/content`,{params:{withIntros:"true"}})}getContentTopics(t,o){return this.http.get(`${this.apiUrl}/library/books/${t}/content/${o}/topics`)}getContentDetails(t,o){return this.http.get(`${this.apiUrl}/library/books/${t}/content/${o}/details`)}getContentInteractions(t,o,r=0,i=10){return this.http.get(`${this.apiUrl}/library/books/${t}/content/${o}/interactions`,{params:{skip:r.toString(),take:i.toString()}})}getContentLastInteractions(t,o,r=10){return this.http.get(`${this.apiUrl}/library/books/${t}/content/${o}/last-interactions`,{params:{take:r.toString()}})}static \u0275fac=function(o){return new(o||e)(b(l))};static \u0275prov=a({token:e,factory:e.\u0275fac,providedIn:"root"})};var S=class e{_id=0;nextId(){return++this._id}static \u0275fac=function(o){return new(o||e)};static \u0275prov=a({token:e,factory:e.\u0275fac,providedIn:"root"})};var x=class e{messageSubject=new s(null);message$=this.messageSubject.asObservable();show(t,o="success",r=2e3){this.messageSubject.next({message:t,type:o,duration:r}),setTimeout(()=>{this.messageSubject.next(null)},r)}static \u0275fac=function(o){return new(o||e)};static \u0275prov=a({token:e,factory:e.\u0275fac,providedIn:"root"})};var I=class e{constructor(t){this.http=t}load(t){return this.http.get(`/content/${t}.md`,{responseType:"text"}).pipe(u(o=>o.status===404?p(`# Content Not Found

The requested content "${t}" could not be found.`):m(()=>o)))}static \u0275fac=function(o){return new(o||e)(b(l))};static \u0275prov=a({token:e,factory:e.\u0275fac,providedIn:"root"})};export{d as a,T as b,S as c,x as d,B as e,j as f,y as g,I as h};
